From: tristanlatr <19967168+tristanlatr@users.noreply.github.com>
Date: Fri, 13 Oct 2023 10:38:22 -0300
Subject: Fix tests with sphinx 7.2.0 and greater (#738)

* Mirror https://github.com/sphinx-doc/sphinx/issues/11246

* Just require 'Sphinx'

(cherry picked from commit 922f81e0408678024e5e09cd52129e38a5b21e75)
---
 pydoctor/napoleon/docstring.py           |  6 ++++--
 pydoctor/test/test_napoleon_docstring.py | 13 +++++++++----
 setup.cfg                                |  2 +-
 3 files changed, 14 insertions(+), 7 deletions(-)

diff --git a/pydoctor/napoleon/docstring.py b/pydoctor/napoleon/docstring.py
index 78e2c8f..0f4a793 100644
--- a/pydoctor/napoleon/docstring.py
+++ b/pydoctor/napoleon/docstring.py
@@ -27,8 +27,10 @@ _google_typed_arg_regex = re.compile(r"(.+?)\(\s*(.*[^\s]+)\s*\)")
 _numpy_section_regex = re.compile(r'^[=\-`:\'"~^_*+#<>]{2,}\s*$')
 _single_colon_regex = re.compile(r"(?<!:):(?!:)")
 _xref_or_code_regex = re.compile(
-    r"((?::(?:[a-zA-Z0-9]+[\-_+:.])*[a-zA-Z0-9]+:`.+?`)|" r"(?:``.+?``))"
-)
+    r'((?::(?:[a-zA-Z0-9]+[\-_+:.])*[a-zA-Z0-9]+:`.+?`)|'
+    r'(?:``.+?``)|'
+    # r'(?::meta .+:.*)|' # 'meta' is not a supported field by pydoctor at the moment.
+    r'(?:`.+?\s*(?<!\x00)<.*?>`))')
 _xref_regex = re.compile(r"(?:(?::(?:[a-zA-Z0-9]+[\-_+:.])*[a-zA-Z0-9]+:)?`.+?`)")
 _bullet_list_regex = re.compile(r"^(\*|\+|\-)(\s+\S|\s*$)")
 _enumerated_list_regex = re.compile(
diff --git a/pydoctor/test/test_napoleon_docstring.py b/pydoctor/test/test_napoleon_docstring.py
index cf2d79a..63c9007 100644
--- a/pydoctor/test/test_napoleon_docstring.py
+++ b/pydoctor/test/test_napoleon_docstring.py
@@ -60,11 +60,11 @@ class BaseDocstringTest(TestCase):
         :param expected: The exact expected reST docstring generated by `pydoctor.napoleon` classes (trailling whitespaces ignored)
         """
         expected_sphinx_output = re.sub(
-                r"(`|\\\s|\\|:mod:|:func:|:class:|:obj:)", "", expected)
+                r"(`|\\\s|\\|:mod:|:func:|:class:|:obj:|:py:mod:|:py:func:|:py:class:|:py:obj:)", "", expected)
 
         # mypy error: Cannot instantiate type "Type[SphinxGoogleDocstring?]
         sphinx_docstring_output = re.sub(
-            r"(`|\\|:mod:|:func:|:class:|:obj:|\s<Ellipsis>)", "",
+            r"(`|\\|:mod:|:func:|:class:|:obj:|:py:mod:|:py:func:|:py:class:|:py:obj:|\s<Ellipsis>)", "",
             str(type_(docstring)).replace( #type: ignore[misc]
             ":kwtype", ":type").replace(":vartype", ":type").replace(" -- ", " - ").replace(':rtype:', ':returntype:').rstrip())
 
@@ -351,10 +351,15 @@ data member description:
         self.assertEqual(expected.rstrip(), actual)
 
     def test_class_data_member_inline(self):
-        docstring = """b: data member description with :ref:`reference`"""
+        docstring = ("b: data member description with :ref:`reference` "
+                     'inline description with '
+                     '``a : in code``, '
+                     'a :ref:`reference`, '
+                     'a `link <https://foo.bar>`_, '
+                     'an host:port and HH:MM strings.')
         actual = str(GoogleDocstring(docstring, is_attribute=True))
         expected = ("""\
-data member description with :ref:`reference`
+data member description with :ref:`reference` inline description with ``a : in code``, a :ref:`reference`, a `link <https://foo.bar>`_, an host:port and HH:MM strings.
 
 :type: `b`""")
         self.assertEqual(expected.rstrip(), actual)
diff --git a/setup.cfg b/setup.cfg
index e503912..eef361b 100644
--- a/setup.cfg
+++ b/setup.cfg
@@ -68,7 +68,7 @@ test =
     hypothesis
     cython-test-exception-raiser
     bs4
-    Sphinx<7.0.0
+    Sphinx
     pytest-subtests
 
 [options.entry_points]
